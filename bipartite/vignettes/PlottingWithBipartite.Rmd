---
title: How to plot networks with bipartite
author: 
  - name: Tobias Bauer
    affiliation: Animal Network Ecology, University of Hamburg
    email: tobias.bauer-2@uni-hamburg.de
date: "`r format(Sys.time(), '%B %d, %Y')`"
abstract: This vignette is intended to give an overview of the plotting capabilities of the bipartite package.
          It includes multiple examples visualizing the intend of the function arguments. 
toc-title: "Contents"
output: 
  rmarkdown::html_vignette:
    toc: true  
    fig_width: 7
    fig_height: 7
editor_options: 
  chunk_output_type: inline
vignette: >
  %\VignetteIndexEntry{How to plot networks with bipartite}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

`r knitr::opts_chunk$set(cache = TRUE, fig.align = 'center', dpi = 300, out.width = "100%")`

# Preparing a web for plotting

First we have to install the `bipartite`-package.

```{r, eval = FALSE}
install.packages("bipartite")
```

After the installation we can load the package.

```{r, results = "hide", message = FALSE, cache = FALSE}
library(bipartite)
```

To be able to demonstrate the different ways to plot a web, we first need ... a web. 
And to get one we might also want to understand how a web is defined in the `bipartite`-package. 

> **Note**: in this document we will only describe the necessary structure of a web. 
For a more in depth guide on how to load your data into `bipartite` have a look at the `Intro2bipartite` vignette.

To do so we will use the function `genweb` that basically generates a random bipartite web. 
The arguements `N1` and `N2` define the number of species in the lower and higher trophic level respectively.

```{r}
web <- genweb(N1 = 5, N2 = 6)
```

After creating the web we might want to have a look at its structure to be able to understand it better.

```{r}
str(web)
web
class(web)
```

As we can see, a web in the `bipartite` package is just an $n \times m$ integer matrix (or more generally a numeric matrix).
The rows and columns represent the nodes of the two independent sets in the graph. 
And the values indicate the weight of the edges between two nodes. 

As `bipartite` is mainly developed with ecological applications in mind, nodes are often equated with individual species in this context.
Ecologists also often think in trophic levels, thus the two independent sets will be referred to as such. 
The columns thus represent the higher trophic level, the rows the lower. 
To demonstrate this, we will change the row and column names within the web. 

```{r}
colnames(web) <- paste("Higher", 1:6)
rownames(web) <- paste("Lower", 1:5)
web
```

To visualize the plotting capabilities of `bipartite` we will use a plant-pollinator web included in the package namely `Safariland`.

```{r}
?Safariland
dim(Safariland)
str(Safariland)
```

As we can see its a 9x27 integer matrix. The help reveals that the 9 rows represent plant species and the 27 columns represent different pollinators.

# Plotting the old way

Now up to the current version `v2.20` of `bipartite` the standard way to visualize this network would be to simply call the function `plotweb`.

> **NOTE:** In this vignette the plotting device is square with a size of 7x7 inches. On devices with other sizes the results may differ.

```{r}
?plotweb
use_deprecated_plotweb(TRUE)
plotweb(web)
plotweb(Safariland)
```

However, as you can see, for larger networks the placement of the labels quickly becomes somewhat confusing.

```{r}
plotweb(Safariland, text.rot = 90)
```

# Plotting the new way

```{r, cache = FALSE, echo = FALSE}
use_deprecated_plotweb(FALSE)
```

Since version `2.23` `bipartite` contains a refined version of the `plotweb` function. 

Among other things the stacking of labels is replaced in that version. 
And instead by default the labels are scaled so that they will always fit in the plot.
The default function call stays the same, so for our randomly generated web the results is. 

```{r, cache = FALSE}
?plotweb
plotweb(web)
```

However when we have a look at the produced plot for the `Safariland` web, ...
```{r}
plotweb(Safariland)
```

we see that for crowded webs this might not be the ideal solution. 
So for webs with many species with long names we recommend rotating the labels (e.g. 90°) via the `srt` argument. 

```{r}
plotweb(Safariland,
        srt = 90)
```

Now the graph is way more readable, even without a magnifying glass.

## Text size and spacing

The "magic" behind 

```{r}
plotweb(Safariland,
        text_size = 0.5,
        spacing = "auto")
```

```{r}
plotweb(Safariland,
        srt = 90,
        text_size = 0.1,
        spacing = "auto")
plotweb(Safariland,
        srt = 90,
        text_size = "auto",
        spacing = 0.5)
```

```{r}
plotweb(Safariland,
        srt = 90,
        text_size = 0.5,
        spacing = 0.5)
```

```{r}
plotweb(Safariland,
        srt = 90,
        text_size = 0.5,
        spacing = c(0.5, 0.3))
```

## Switching to a horizontal plot

If you prefer your labels to be horizontal, 
another option is to rotate the whole plot by 90° altogether. 
This can be accomplished by setting `horizontal = TRUE`.

```{r}
plotweb(web,
        horizontal = TRUE)
```

```{r}
plotweb(Safariland,
        horizontal = TRUE)
```

Now we are able to clearly read every single label and interpret the plotted interactions.

## Sorting the web

By default the species in the plot are arranged just like the rows and columns in the given web matrix. So the first row/column is plotted at the bottom/left of the plot. So to arrange the plot in a specific order that order just has to be given during the call of `plotweb`.

```{r}
plotweb(Safariland[rev(rownames(Safariland)), ], horizontal = TRUE)
```

Now the plant species are plotted in reverse order.

However a built-in call to `sortweb` is also possible with the argument `sorting`. 
The options are the same as for `sortweb`. 
So `dec` orders the species in decreasing row/column totals, `inc` orders by increasing totals, and `ca` performs a ca algorithm which might reduce link crossings in the plot.

```{r}
plotweb(Safariland,
        horizontal = TRUE,
        sorting = "dec")
plotweb(Safariland,
        horizontal = TRUE,
        sorting = "inc")
plotweb(Safariland,
        horizontal = TRUE,
        sorting = "ca")
```

## Adding independent abundances

In some cases beside the recorded interactions there might also be data about the actual abundance of each or some species available. 
Now it might be interesting to alter the plot so that the boxes visualize these abundances while still representing the recorded interaction preferences via the link widths. 
This can be accomplished with the two arguments `higher_abundances` and `lower_abundances`.

These accept a named vector each for the higher trophic level species (columns) and lower trophic level species (rows).

Since we don't have actual recorded abundances we will generate some randomly for demonstration.

```{r}
n_lower_species <- nrow(Safariland)
lower_abundances <- sample(0:100, n_lower_species, replace = TRUE)
print(lower_abundances)
names(lower_abundances) <- rownames(Safariland)
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        lower_abundances = lower_abundances)
```

We now have abundances for the pollinator species that were randomly drawn form a uniform distribution between 0 and 100. 
As we can see the box sizes on the left are more homogenous.

We can also see that some of the links are increasing or decreasing in size from the left to the right.

## Switching to absolute scaling

In many cases having independent abundances will lead to the total abundances on one side being larger than on the other side. 
However by default the `plotweb` function will make both sides use the maximum available space.

If you are interested in the absolute relations between both sides you need to set the option `scaling = "absolute"`. 
To demonstrate the difference we will generate uniformly random abundance value for the pollinator that are much larger than the actual values in the web.

```{r}
n_higher_species <- ncol(Safariland)
higher_abundances <- sample(0:1000, n_higher_species, replace = TRUE)
names(higher_abundances) <- colnames(Safariland)
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        higher_abundances = higher_abundances,
        scaling = "relative")
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        higher_abundances = higher_abundances,
        scaling = "absolute")
```

As you can see in the second plot the boxes on the right are scaled according to the total abundances on the left and are thus much smaller.

## Adding additional abundances

In some cases there are individuals which didn't participate in any interactions but are still counted (e.g. parasited vs. unparasited hosts). For those cases specify independent abundances doesn't work. However these additional abundances can be defined using the arguments `add_higher_abundances` and `add_lower_abundances`. Both arguments, just as their independent counterparts, take a named vector of all species as input. To demonstrate we take the same abundances as above.

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        add_lower_abundances = lower_abundances)
```

As you can see the additional abundances are now plotted as red extra boxes on top of the original boxes.

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        add_lower_abundances = lower_abundances,
        lower_add_color = "darkgreen")
```

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        add_lower_abundances = lower_abundances,
        lower_add_color = "darkgreen",
        scaling = "absolute")
```

# Changing the style

## Switching to curved links

With the option `curved_links = TRUE` the interaction links can be changed from straight lines to curves.

```{r}
plotweb(Safariland,
        srt = 90,
        curved_links = TRUE)
plotweb(Safariland,
        horizontal = TRUE,
        curved_links = TRUE)
```

## Making the species labels cursive

The options `higher_italic` and `lower_italic` make the higher trophic level and lower trophic level species labels respectively cursive.

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        curved_links = TRUE,
        higher_italic = TRUE,
        lower_italic = TRUE)
```

```{r}
higher_labels <- colnames(Safariland)
names(higher_labels) <- higher_labels
species_name_selector <- lengths(strsplit(higher_labels, " ")) == 2
higher_species_names <- higher_labels[species_name_selector]
higher_labels[higher_species_names] <- lapply(higher_species_names,
                                              function(x) bquote(italic(.(x))))

plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        curved_links = TRUE,
        higher_labels = higher_labels,
        lower_italic = TRUE)
```

## Changing the color of all species

With the arguments `higher_color` and `lower_color` the colors of the boxes can be changed. For example setting these to a single color value changes the color of all boxes on each side.

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        curved_links = TRUE,
        higher_labels = higher_labels,
        lower_italic = TRUE,
        higher_color = "orange",
        lower_color = "darkgreen")

```

As you can see all boxes on the left (higher or columns) are orange and all boxes on the right (lower or rows) are dark green.

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        curved_links = TRUE,
        higher_labels = higher_labels,
        lower_italic = TRUE,
        higher_color = 1:ncol(Safariland))
```

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        curved_links = TRUE,
        higher_labels = higher_labels,
        lower_italic = TRUE,
        lower_color = rainbow(nrow(Safariland)))
```

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        curved_links = TRUE,
        higher_labels = higher_labels,
        lower_italic = TRUE,
        higher_color = hcl.colors(ncol(Safariland), palette = "Dark 3"))
```

## Changing the color of some species

However oftentimes we want to highlight just a few species. For the example below we are especially interested in the interaction of the plant species *Alstroemeria aurea*. So in the first step we generate a vector for all lower species and fill it with the value `"black"`. In the next step we change the value only for the considered species to `"orange"`.

```{r}
lower_color <- rep("black", nrow(Safariland))
names(lower_color) <- rownames(Safariland)
lower_color["Alstroemeria aurea"] <- "orange"
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        curved_links = TRUE,
        higher_labels = higher_labels,
        lower_italic = TRUE,
        lower_color = lower_color)

```

As you can see now only the box of *Alstroemeria aurea* is orange.

## Changing the color of the links

In the example above we highlighted the box of our species of interest. But it would be even nicer if we could highlight all the interactions that species has in the same color as well. To do so we just have to switch the option `link_color = "higher"` to `link_color = "lower"`.

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        curved_links = TRUE,
        higher_labels = higher_labels,
        lower_italic = TRUE,
        lower_color = lower_color,
        link_color = "lower")
```

Of course you can also set all the links to a single color value.

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        curved_links = TRUE,
        higher_labels = higher_labels,
        lower_italic = TRUE,
        higher_color = "orange",
        lower_color = "darkgreen",
        link_color = "brown")
```

## Changing the color of additional abundances

Of course the color of the additional abundance boxes can be specified as well via the options `higher_add_color` and `lower_add_color`.

```{r}
lower_add_color <- rep("black", nrow(Safariland))
lower_color <- rep("gray50", nrow(Safariland))
names(lower_add_color) <- rownames(Safariland)
names(lower_color) <- rownames(Safariland)
lower_add_color["Alstroemeria aurea"] <- "darkorange"
lower_color["Alstroemeria aurea"] <- "orange"
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        add_lower_abundances = lower_abundances,
        curved_links = TRUE,
        higher_labels = higher_labels,
        higher_color = "gray50",
        lower_italic = TRUE,
        lower_color = lower_color,
        link_color = "lower",
        lower_add_color = lower_add_color)
```


```{r}
lower_add_color <- rep("black", nrow(Safariland))
lower_color <- rep("gray50", nrow(Safariland))
names(lower_add_color) <- rownames(Safariland)
names(lower_color) <- rownames(Safariland)
lower_add_color["Alstroemeria aurea"] <- "darkorange4"
lower_color["Alstroemeria aurea"] <- "orange"
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,      
        add_lower_abundances = lower_abundances,
        curved_links = TRUE,
        higher_labels = higher_labels,
        higher_color = "gray50",
        lower_italic = TRUE,
        lower_color = lower_color,
        link_color = "lower",
        link_alpha = 1,
        higher_border = "black",
        link_border = "black",
        lower_border = "black",
        lower_add_color = lower_add_color)
```