---
title: How to plot networks with bipartite
author: 
  - name: Tobias Bauer
    affiliation: Animal Network Ecology, University of Hamburg
    email: tobias.bauer-2@uni-hamburg.de
date: "`r format(Sys.time(), '%B %d, %Y')`"
abstract: This vignette is intended to give an overview of the plotting capabilities of the bipartite package.
          It includes multiple examples visualizing the intend of the function arguments. 
toc-title: "Contents"
output: 
  rmarkdown::html_vignette:
    toc: true  
    fig_width: 7
    fig_height: 7
editor_options: 
  chunk_output_type: inline
vignette: >
  %\VignetteIndexEntry{How to plot networks with bipartite}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

`r knitr::opts_chunk$set(cache = TRUE, fig.align = 'center', dpi = 300, out.width = "100%")`

# Preparing a web for plotting

First we have to install the `bipartite`-package.

```{r, eval = FALSE}
install.packages("bipartite")
```

After the installation we can load the package.

```{r, results = "hide", message = FALSE, cache = FALSE}
library(bipartite)
```

To be able to demonstrate the different ways to plot a web, we first need ... a web. 
And to get one we might also want to understand how a web is defined in the `bipartite`-package. 

> **Note**: in this document we will only describe the necessary structure of a web. 
For a more in depth guide on how to load your data into `bipartite` have a look at the `Intro2bipartite` vignette.

To do so we will use the function `genweb` that basically generates a random bipartite web. 
The arguements `N1` and `N2` define the number of species in the lower and higher trophic level respectively.

```{r}
web <- genweb(N1 = 5, N2 = 6)
```

After creating the web we might want to have a look at its structure to be able to understand it better.

```{r}
str(web)
web
class(web)
```

As we can see, a web in the `bipartite` package is just an $n \times m$ integer matrix (or more generally a numeric matrix).
The rows and columns represent the nodes of the two independent sets in the graph. 
And the values indicate the weight of the edges between two nodes. 

As `bipartite` is mainly developed with ecological applications in mind, nodes are often equated with individual species in this context.
Ecologists also often think in trophic levels, thus the two independent sets will be referred to as such. 
The columns thus represent the higher trophic level, the rows the lower. 
To demonstrate this, we will change the row and column names within the web. 

```{r}
colnames(web) <- paste("Higher", 1:6)
rownames(web) <- paste("Lower", 1:5)
web
```

To visualize the plotting capabilities of `bipartite` we will use a plant-pollinator web included in the package namely `Safariland`.

```{r}
?Safariland
dim(Safariland)
str(Safariland)
```

As we can see its a 9x27 integer matrix. The help reveals that the 9 rows represent plant species and the 27 columns represent different pollinators.

# Plotting the old way

Now up to the current version `v2.20` of `bipartite` the standard way to visualize this network would be to simply call the function `plotweb`.

> **NOTE:** In this vignette the plotting device is square with a size of 7x7 inches. On devices with other sizes the results may differ.

```{r}
?plotweb
use_deprecated_plotweb(TRUE)
plotweb(web)
plotweb(Safariland)
```

However, as you can see, for larger networks the placement of the labels quickly becomes somewhat confusing.

```{r}
plotweb(Safariland, text.rot = 90)
```

# Plotting the new way

```{r use_deprecated, cache = FALSE, echo = FALSE}
use_deprecated_plotweb(FALSE)
```

Since version `2.23` `bipartite` contains a refined version of the `plotweb` function. 

Among other things the stacking of labels is replaced in that version. 
And instead by default the labels are scaled so that they will always fit in the plot.
The default function call stays the same, so for our randomly generated web the results is. 

```{r first_plot, cache = FALSE}
plotweb(web)
```

However, when we have a look at the plot produced for the `Safariland` web, ...
```{r new_safariland}
plotweb(Safariland)
```

it becomes clear that this approach may not be ideal for crowded webs.
So for for networks with many species—especially those with long names—we recommend rotating the axis labels (e.g., by 90°) using the `srt` argument. 

```{r safariland_90}
plotweb(Safariland,
        srt = 90)
```

Now the graph is way more readable, even without a magnifying glass.

## Text size and spacing

The "magic" behind 

```{r}
plotweb(Safariland,
        text_size = 0.5,
        spacing = "auto")
```

```{r}
plotweb(Safariland,
        srt = 90,
        text_size = 0.1,
        spacing = "auto")
plotweb(Safariland,
        srt = 90,
        text_size = "auto",
        spacing = 0.5)
```

```{r}
plotweb(Safariland,
        srt = 90,
        text_size = 0.5,
        spacing = 0.5)
```

```{r}
plotweb(Safariland,
        srt = 90,
        text_size = 0.5,
        spacing = c(0.5, 0.3))
```

## Switching to a horizontal plot

If you prefer your labels to be horizontal, 
another option is to rotate the whole plot by 90° altogether. 
This can be accomplished by setting `horizontal = TRUE`.

```{r web_horizontal}
plotweb(web,
        horizontal = TRUE)
```

```{r safariland_horizontal}
plotweb(Safariland,
        horizontal = TRUE)
```

Now we are able to clearly read every single label and interpret the plotted interactions.

## Sorting the web

By default, the species in the plot are arranged according to the rows and columns of the given web matrix.
The first row/column is therefore plotted at the left of the plot (or at the top for horizontal plots).
To arrange the plot in a specific order, simply provide that order when calling plotweb.
Like in the example below, in which we reverese the row order for the `plotweb` call. 

```{r sorting_reverse}
plotweb(web[rev(rownames(web)), ], horizontal = TRUE)
plotweb(Safariland[rev(rownames(Safariland)), ], horizontal = TRUE)
```

Now the plant species are plotted in reverse order.

However a built-in call to `sortweb` is also possible with the argument `sorting`. 
The options are the same as for `sortweb`. 
So `dec` orders the species in decreasing row/column totals, `inc` orders by increasing totals, 
and `ca` performs a correspondence analysis which might reduce link crossings in the plot.

```{r sorting_all}
plotweb(Safariland,
        horizontal = TRUE,
        sorting = "dec")
plotweb(Safariland,
        horizontal = TRUE,
        sorting = "inc")
plotweb(Safariland,
        horizontal = TRUE,
        sorting = "ca")
```

## Adding independent abundances

In some cases, in addition to the recorded interactions, data on the actual abundance of some or all species may also be available.
In such cases, it can be useful to modify the plot so that the boxes reflect species abundances, while the link widths continue to represent interaction preferences.
This can be done using the two arguments `higher_abundance` and `lower_abundances`.

These take a named vector each—for the higher trophic level species (columns) and the lower trophic level species (rows).

Since we don't have actual recorded abundances, we will generate some randomly for demonstration purposes.

```{r}
n_lower_species <- nrow(Safariland)
lower_abundances <- sample(0:100, n_lower_species, replace = TRUE)
names(lower_abundances) <- rownames(Safariland)
print(lower_abundances)
```

Now we have a named vector with a random abundance for each row (lower-level species / plants) in the `Safariland` web, 
as required by the funciton. When we call the function with this argument, we get the following result.

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        lower_abundances = lower_abundances)
```

We now have abundances for the pollinator species that were randomly drawn form a uniform distribution between 0 and 100. 
As we can see the box sizes on the right are more homogenous.

We can also see that some of the links are increasing or decreasing in size from the left to the right.

## Adding additional abundances

In some cases there are individuals which didn't participate in any interactions but are still counted (e.g. parasited vs. unparasited hosts). 
For those cases specifying independent abundances doesn't work. 
However, these additional abundances can be defined using the arguments `add_higher_abundances` and `add_lower_abundances`. 
Both arguments, just as their independent counterparts, take a named vector of all species as input. 
To demonstrate we take the same abundances as above.

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        add_lower_abundances = lower_abundances)
```

As you can see the additional abundances are now plotted as red extra boxes on top of the original boxes.

## Switching to absolute scaling

In many cases having independent abundances will lead to the total abundances on one side being larger than on the other side. 
However by default the `plotweb` function will make both sides use the maximum available space.

If you are interested in the absolute relations between both sides you need to set the option `scaling = "absolute"`. 
To demonstrate the difference we will generate uniformly random abundance value for the pollinator that are much larger than the actual values in the web.

```{r}
n_higher_species <- ncol(Safariland)
higher_abundances <- sample(0:1000, n_higher_species, replace = TRUE)
names(higher_abundances) <- colnames(Safariland)
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        higher_abundances = higher_abundances,
        scaling = "relative")
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        higher_abundances = higher_abundances,
        scaling = "absolute")
```

In the same way as for independent abundances a plot with additional abundances is by default scaled in a relative 
manner. That means the boxes on both sides use as much space as possible. However, 

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        add_lower_abundances = lower_abundances,
        scaling = "absolute")
```

# Changing the style

Now after understanding the basics of plotting bipartite networks, 
we will have a look at how you can make the plots fit the aestetics you are looking for. 

## Switching to curved links

With the option `curved_links = TRUE` the interaction links can be changed from straight lines to curves.

```{r}
plotweb(Safariland,
        srt = 90,
        curved_links = TRUE)
```

This obviously also works for horizontal plots.

```{r}
plotweb(Safariland,
        horizontal = TRUE,
        curved_links = TRUE)
```

## Making the species labels cursive

The options `higher_italic` and `lower_italic` make the higher trophic level and lower trophic level species labels respectively cursive.

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        curved_links = TRUE,
        higher_italic = TRUE,
        lower_italic = TRUE)
```

```{r}
higher_labels <- colnames(Safariland)
names(higher_labels) <- higher_labels
species_name_selector <- lengths(strsplit(higher_labels, " ")) == 2
higher_species_names <- higher_labels[species_name_selector]
higher_labels[higher_species_names] <- lapply(higher_species_names,
                                              function(x) bquote(italic(.(x))))

plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        curved_links = TRUE,
        higher_labels = higher_labels,
        lower_italic = TRUE)
```

## Changing the color of all species

With the arguments `higher_color` and `lower_color` the colors of the boxes can be changed. For example setting these to a single color value changes the color of all boxes on each side.

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        curved_links = TRUE,
        higher_labels = higher_labels,
        lower_italic = TRUE,
        higher_color = "orange",
        lower_color = "darkgreen")

```

As you can see all boxes on the left (higher or columns) are <span style="color:orange;">orange</span> 
and all boxes on the right (lower or rows) are <span style="color:darkgreen;">dark green</span>.

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        curved_links = TRUE,
        higher_labels = higher_labels,
        lower_italic = TRUE,
        higher_color = 1:ncol(Safariland))
```

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        curved_links = TRUE,
        higher_labels = higher_labels,
        lower_italic = TRUE,
        lower_color = rainbow(nrow(Safariland)))
```

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        curved_links = TRUE,
        higher_labels = higher_labels,
        lower_italic = TRUE,
        higher_color = hcl.colors(ncol(Safariland), palette = "Dark 3"))
```

## Changing the color of some species

However oftentimes we want to highlight just a few species. For the example below we are especially interested in the interaction of the plant species *Alstroemeria aurea*. So in the first step we generate a vector for all lower species and fill it with the value `"black"`. In the next step we change the value only for the considered species to `"orange"`.

```{r}
lower_color <- rep("black", nrow(Safariland))
names(lower_color) <- rownames(Safariland)
lower_color["Alstroemeria aurea"] <- "orange"
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        curved_links = TRUE,
        higher_labels = higher_labels,
        lower_italic = TRUE,
        lower_color = lower_color)

```

As you can see now only the box of <span style="color:orange;">*Alstroemeria aurea*</span> is orange.

## Changing the color of the links

In the example above we highlighted the box of our species of interest. But it would be even nicer if we could highlight all the interactions that species has in the same color as well. To do so we just have to switch the option `link_color = "higher"` to `link_color = "lower"`.

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        curved_links = TRUE,
        higher_labels = higher_labels,
        lower_italic = TRUE,
        lower_color = lower_color,
        link_color = "lower")
```

Of course you can also set all the links to a single color value.

```{r}
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        curved_links = TRUE,
        higher_labels = higher_labels,
        lower_italic = TRUE,
        higher_color = "orange",
        lower_color = "darkgreen",
        link_color = "brown")
```

In doing so you can create very colorful plots. 

## Changing the color of additional abundances

Of course the color of the additional abundance boxes can be specified as well via the options `higher_add_color` and `lower_add_color`.

```{r}
lower_add_color <- rep("black", nrow(Safariland))
lower_color <- rep("gray50", nrow(Safariland))
names(lower_add_color) <- rownames(Safariland)
names(lower_color) <- rownames(Safariland)
lower_add_color["Alstroemeria aurea"] <- "darkorange"
lower_color["Alstroemeria aurea"] <- "orange"
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        add_lower_abundances = lower_abundances,
        curved_links = TRUE,
        higher_labels = higher_labels,
        higher_color = "gray50",
        lower_italic = TRUE,
        lower_color = lower_color,
        link_color = "lower",
        lower_add_color = lower_add_color)
```

## Link alpha value and border 

In all of the examples above, the links appear partially transparent. This effect is controlled by the `link_alpha` parameter, which defaults to `0.5`. To reduce transparency and make the links more opaque, you can increase this value—for instance, setting it to `1.0` will render the links fully opaque.

Another group of style parameters with default values relates to the border color of boxes and links. By default, these are set to `"same"`, meaning the border color matches the corresponding box or link color exactly. You can also specify a single color or use named vectors to apply different colors. In the example below, we set all border colors to `"black"`.

We also modify the fill colors of the boxes and the links slightly for visual variation.

```{r}
lower_add_color <- rep("black", nrow(Safariland))
lower_color <- rep("gray50", nrow(Safariland))
names(lower_add_color) <- rownames(Safariland)
names(lower_color) <- rownames(Safariland)
lower_add_color["Alstroemeria aurea"] <- "darkorange4"
lower_color["Alstroemeria aurea"] <- "orange"
plotweb(Safariland,
        sorting = "ca",
        horizontal = TRUE,
        add_lower_abundances = lower_abundances,
        curved_links = TRUE,
        higher_labels = higher_labels,
        higher_color = "gray50",
        lower_italic = TRUE,
        lower_color = lower_color,
        link_color = "lower",
        link_alpha = 1,
        higher_border = "black",
        link_border = "black",
        lower_border = "black",
        lower_add_color = lower_add_color)
```